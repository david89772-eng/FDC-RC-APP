<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾ç†Ÿåº¦åˆ†æç³»çµ± - è¡Œå‹•å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* åŸºç¤æ¨£å¼èˆ‡è¡Œå‹•ç«¯å„ªåŒ– */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f4f8; padding: 15px; color: #333; margin: 0; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { color: #2c3e50; font-size: 1.25rem; margin-top: 0; border-left: 5px solid #3498db; padding-left: 12px; margin-bottom: 15px; }
        
        /* å½ˆæ€§ä½ˆå±€å„ªåŒ– */
        .flex-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 140px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #555; font-size: 0.9rem; }
        
        /* è¼¸å…¥å…ƒä»¶åŠ å¤§ï¼Œæ–¹ä¾¿æ‰‹æŒ‡è§¸æ§ */
        select, input, button { 
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; appearance: none; -webkit-appearance: none;
        }
        button { background: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; active { transform: scale(0.98); } }
        button:hover { background: #2980b9; }
        
        /* æ–‡å­—è¡¨æ ¼è¡Œå‹•ç«¯æ»¾å‹• */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #eee; }
        .summary-table { width: 100%; border-collapse: collapse; min-width: 300px; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .summary-table th { background: #f8f9fa; color: #3498db; }
        .count-badge { background: #e8f8f0; color: #2ecc71; padding: 4px 12px; border-radius: 12px; font-weight: bold; }

        /* å€‹äººæŒ‰éˆ•æµå‹•ä½ˆå±€ */
        .user-btn-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .user-btn { 
            background: #fff; color: #3498db; border: 2px solid #3498db; 
            padding: 10px 5px; font-size: 14px; border-radius: 8px; text-align: center;
        }
        .user-btn.active { background: #3498db; color: white; } 
        
        /* åœ–è¡¨éŸ¿æ‡‰å¼å®¹å™¨ */
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
        .chart-container { background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #eee; height: 300px; position: relative; }
        .radar-box { height: 400px; width: 100%; margin: 0 auto; }

        /* æ‰‹æ©Ÿç‰ˆå°ˆç”¨å¾®èª¿ */
        @media (max-width: 480px) {
            .card { padding: 15px; }
            .input-group { min-width: 100%; } /* æ‰‹æ©Ÿä¸Šå›å ±è¼¸å…¥æ¡†æ”¹ç‚ºå…¨å¯¬ */
            button { padding: 16px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸš€ å¿«é€Ÿå›å ±</h2>
        <div class="flex-row">
            <div class="input-group">
                <label>é¸æ“‡äººå“¡</label>
                <select id="userName"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="input-group">
                <label>é¸æ“‡ä»»å‹™</label>
                <select id="taskName"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div style="width: 100%; margin-top: 5px;">
                <button onclick="submitReport()">ç¢ºèªæäº¤å›å ±</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“Š å€é–“çµ±è¨ˆæ‘˜è¦</h2>
        <div class="flex-row">
            <div class="input-group"><label>èµ·å§‹</label><input type="date" id="startDate"></div>
            <div class="input-group"><label>çµæŸ</label><input type="date" id="endDate"></div>
            <button style="background:#27ae60; flex: 1;" onclick="updateDashboard()">æ›´æ–°æŸ¥è©¢</button>
        </div>

        <div class="table-scroll">
            <table class="summary-table">
                <thead>
                    <tr><th>ä»»å‹™é …ç›®</th><th>ç¸½è¨ˆ</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="chartsGrid" class="charts-grid"></div>

    <div class="card">
        <h2>ğŸ‘¤ å€‹äººç”Ÿæ¶¯èƒ½åŠ›åˆ†æ</h2>
        <div id="userButtons" class="user-btn-group"></div>
        <div class="radar-box">
            <canvas id="personalRadarChart"></canvas>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwM-y3UbUnGxRbvDzsIRwUKP4QuFa5CS75sGfaEqhAXFnhnY9ZCUsZsKpVQ8ZxaQTyxFQ/exec"; 
    const EMPLOYEE_LIST = ["è—éˆæ…¶", "å¼µèŒµå©•", "æ²ˆå¥‡å¼˜", "é‚±æ¯“å“²", "é™³ç‡ç‘¢", "æŸ¯ä¼¯ç¿°", "é™³åˆç‘‹", "ç›§è©©é›¨", "è¬å¿ƒäº‘", "å–®è™¹", "è¬ç§‰è«º", "è•­ä½‘çŠ", "ææ˜Œæ©", "æ—æŸå¿—", "æ—åšæš", "å¾æ¥·èŒµ", "è‘‰é¦™å¦¤", "ç°¡å›åº­", "æ—è™¹ç‘©"];
    const TASK_LIST = ["é‡‘é¾å±±æ—¥å‡º", "ç¶ å»Šæ¢éšªéšŠ", "å¤©æ°£ç“¶DIY", "å£“å…‹åŠ›æ¿ç•«", "æ™¨æ›¦æ¼«æ­¥", "VIK", "é ˜é¨å°è¦½", "æ™šé–“è¡¨æ¼”"];
    
    let radarChart = null;
    let allData = [];

    function setupUI() {
        const userSelect = document.getElementById('userName');
        const taskSelect = document.getElementById('taskName');
        const userButtons = document.getElementById('userButtons');
        
        userSelect.innerHTML = '<option value="">-- é¸æ“‡äººå“¡ --</option>';
        taskSelect.innerHTML = '<option value="">-- é¸æ“‡ä»»å‹™ --</option>';

        EMPLOYEE_LIST.forEach(name => {
            userSelect.add(new Option(name, name));
            const btn = document.createElement('div'); // æ‰‹æ©Ÿç‰ˆæ”¹ç”¨ div æ¨¡æ“¬æŒ‰éˆ•æ›´å¥½æ§åˆ¶æ¨£å¼
            btn.className = 'user-btn';
            btn.innerText = name;
            btn.onclick = () => showPersonalRadar(name, btn);
            userButtons.appendChild(btn);
        });
        TASK_LIST.forEach(task => taskSelect.add(new Option(task, task)));
    }

    async function loadDataAndDraw() {
        try {
            const res = await fetch(API_URL);
            allData = await res.json(); 
            updateDashboard();
            const firstBtn = document.querySelector('.user-btn');
            if(firstBtn) firstBtn.click();
        } catch (e) {
            console.error("Data load failed", e);
        }
    }

    function updateDashboard() {
        updateTextTable(); 
        updateBarCharts(); 
    }

    function updateTextTable() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        TASK_LIST.forEach(task => {
            const total = allData.slice(1).filter(row => {
                const d = new Date(row[2]);
                return row[1] === task && (!start || d >= new Date(start)) && (!end || d <= new Date(end));
            }).length;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${task}</td><td><span class="count-badge">${total}</span></td>`;
            tbody.appendChild(tr);
        });
    }

    function updateBarCharts() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const grid = document.getElementById('chartsGrid');
        grid.innerHTML = '';

        TASK_LIST.forEach(task => {
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-container';
            wrapper.innerHTML = `<canvas id="bar-${task}"></canvas>`;
            grid.appendChild(wrapper);

            const stats = EMPLOYEE_LIST.map(name => {
                return allData.slice(1).filter(row => {
                    const d = new Date(row[2]);
                    return row[0] === name && row[1] === task && (!start || d >= new Date(start)) && (!end || d <= new Date(end));
                }).length;
            });

            new Chart(document.getElementById(`bar-${task}`), {
                type: 'bar',
                data: { labels: EMPLOYEE_LIST, datasets: [{ label: 'å®Œæˆæ¬¡æ•¸', data: stats, backgroundColor: '#3498db' }] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: task } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        });
    }

    function showPersonalRadar(name, btnElement) {
        document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');

        const stats = TASK_LIST.map(task => allData.slice(1).filter(row => row[0] === name && row[1] === task).length);
        const ctx = document.getElementById('personalRadarChart').getContext('2d');
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: TASK_LIST,
                datasets: [{
                    label: name,
                    data: stats,
                    backgroundColor: 'rgba(231, 76, 60, 0.2)',
                    borderColor: '#e74c3c',
                    pointBackgroundColor: '#e74c3c'
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { r: { beginAtZero: true, ticks: { display: false, stepSize: 1 } } }
            }
        });
    }

    async function submitReport() {
        const name = document.getElementById('userName').value;
        const task = document.getElementById('taskName').value;
        if (!name || !task) return alert("è«‹å®Œæ•´å¡«å¯«äººå“¡èˆ‡ä»»å‹™");
        if (!confirm(`ç¢ºèªæäº¤ï¼š${name} - ${task}ï¼Ÿ`)) return;

        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name, task }) });
        alert("æäº¤æˆåŠŸï¼æ•¸æ“šç¨å¾Œè‡ªå‹•æ›´æ–°ã€‚");
        loadDataAndDraw();
    }

    window.onload = function() {
        setupUI();
        const now = new Date();
        document.getElementById('startDate').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        loadDataAndDraw();
    };
</script>
</body>
</html>