<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾ç†Ÿåº¦åˆ†æç³»çµ± v7.5 - æ’ç‰ˆå„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f4f8; padding: 15px; color: #333; margin: 0; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { color: #2c3e50; font-size: 1.25rem; margin-top: 0; border-left: 5px solid #3498db; padding-left: 12px; margin-bottom: 15px; }
        .flex-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 140px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #555; font-size: 0.9rem; }
        select, input, button { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:active { transform: scale(0.98); }
        .table-scroll { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .summary-table th { background: #f8f9fa; color: #3498db; }
        .count-badge { background: #e8f8f0; color: #2ecc71; padding: 4px 12px; border-radius: 12px; font-weight: bold; }
        
        /* æ‘ºç–Šé¢æ¿æ¨£å¼ - å·²ä½µå…¥æ‘˜è¦å¡ç‰‡ */
        .charts-grid { display: flex; flex-direction: column; gap: 8px; }
        .accordion-item { background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #f0f0f0; }
        .accordion-header { width: 100%; padding: 12px 15px; background: #fcfcfc; text-align: left; border: none; outline: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; color: #555; font-size: 0.95rem; }
        .accordion-header::after { content: 'â–¼'; font-size: 10px; color: #bbb; transition: 0.3s; }
        .accordion-header.active::after { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 10px; border-top: 1px solid #f9f9f9; }
        .chart-container { height: 350px; position: relative; width: 100%; }
        
        /* é›·é”åœ–å€å¡Šæ¨£å¼ */
        .user-btn-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .user-btn { background: #fff; color: #3498db; border: 2px solid #3498db; padding: 10px 5px; font-size: 14px; border-radius: 8px; text-align: center; cursor: pointer; }
        .user-btn.active { background: #3498db; color: white; }
        .radar-box { height: 350px; width: 100%; margin: 0 auto; }
        .radar-data-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 0.9rem; }
        .radar-data-table td { border: 1px solid #f0f0f0; padding: 8px; text-align: center; }
        .radar-data-table tr:nth-child(even) { background-color: #fafafa; }
        .label-cell { color: #666; font-weight: bold; width: 60%; text-align: left !important; padding-left: 15px !important; }
        .value-cell { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸš€ å¿«é€Ÿå›å ±</h2>
        <div class="flex-row">
            <div class="input-group">
                <label>é¸æ“‡äººå“¡</label>
                <select id="userName"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="input-group">
                <label>é¸æ“‡ä»»å‹™</label>
                <select id="taskName"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div style="width: 100%; margin-top: 5px;">
                <button onclick="submitReport()">ç¢ºèªæäº¤å›å ±</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“Š å€é–“çµ±è¨ˆæ‘˜è¦èˆ‡æ’è¡Œ</h2>
        <div class="flex-row">
            <div class="input-group"><label>èµ·å§‹</label><input type="date" id="startDate"></div>
            <div class="input-group"><label>çµæŸ</label><input type="date" id="endDate"></div>
            <button style="background:#27ae60; flex: 1;" onclick="updateDashboard()">æ›´æ–°æŸ¥è©¢æ•¸æ“š</button>
        </div>
        
        <div class="table-scroll">
            <table class="summary-table">
                <thead><tr><th>ä»»å‹™é …ç›®</th><th>ç¸½è¨ˆ</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="chartsGrid" class="charts-grid"></div>
    </div>

    <div class="card">
        <h2>ğŸ‘¤ å€‹äººç²¾ç†Ÿåº¦åˆ†æ (å€é–“æœ€é•·3å€‹æœˆ)</h2>
        <div class="flex-row">
            <div class="input-group"><label>é›·é”èµ·å§‹</label><input type="date" id="radarStartDate"></div>
            <div class="input-group"><label>é›·é”çµæŸ</label><input type="date" id="radarEndDate"></div>
        </div>
        <div id="userButtons" class="user-btn-group"></div>
        
        <div class="radar-box"><canvas id="personalRadarChart"></canvas></div>
        
        <div id="radarDataTableContainer" style="margin-top: 20px;">
            <table class="radar-data-table" id="radarDataTable"></table>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw9UXoLvamhrHlsKn5qIewfoN566JGoLCc6k-OakkpjoN_YF2_OtGuaGnFfQchuy0Ah0Q/exec"; 
    const EMPLOYEE_LIST = ["è—éˆæ…¶", "å¼µèŒµå©•", "æ²ˆå¥‡å¼˜", "é‚±æ¯“å“²", "é™³ç‡ç‘¢", "æŸ¯ä¼¯ç¿°", "é™³åˆç‘‹", "ç›§è©©é›¨", "è¬å¿ƒäº‘", "å–®è™¹", "è¬ç§‰è«º", "è•­ä½‘çŠ", "ææ˜Œæ©", "æ—æŸå¿—", "æ—åšæš", "å¾æ¥·èŒµ", "è‘‰é¦™å¦¤", "ç°¡å›åº­", "æ—è™¹ç‘©"];
    const TASK_LIST = ["é‡‘é¾å±±æ—¥å‡º", "ç¶ å»Šæ¢éšªéšŠ", "å¤©æ°£ç“¶DIY", "å£“å…‹åŠ›æ¿ç•«", "æ™¨æ›¦æ¼«æ­¥", "VIK", "é ˜é¨å°è¦½", "æ™šé–“è¡¨æ¼”"];
    
    let radarChart = null;
    let allData = [];
    let currentUserName = "";

    function setupUI() {
        const userSelect = document.getElementById('userName');
        const taskSelect = document.getElementById('taskName');
        const userButtons = document.getElementById('userButtons');
        userSelect.innerHTML = '<option value="">-- é¸æ“‡äººå“¡ --</option>';
        taskSelect.innerHTML = '<option value="">-- é¸æ“‡ä»»å‹™ --</option>';
        EMPLOYEE_LIST.forEach(name => {
            userSelect.add(new Option(name, name));
            const btn = document.createElement('div');
            btn.className = 'user-btn';
            btn.innerText = name;
            btn.onclick = () => { currentUserName = name; showPersonalRadar(name, btn); };
            userButtons.appendChild(btn);
        });
        TASK_LIST.forEach(task => taskSelect.add(new Option(task, task)));
    }

    async function loadDataAndDraw() {
        try {
            const res = await fetch(API_URL + "?getdata=1");
            allData = await res.json(); 
            updateDashboard();
            const firstBtn = document.querySelector('.user-btn');
            if(firstBtn) firstBtn.click();
        } catch (e) { console.error("è³‡æ–™åŠ è¼‰å¤±æ•—", e); }
    }

    function updateDashboard() {
        updateTextTable(); 
        updateBarCharts(); 
    }

    function updateTextTable() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (!allData || allData.length <= 1) return;
        TASK_LIST.forEach(task => {
            const total = allData.slice(1).filter(row => {
                const d = new Date(row[2]);
                return row[1] === task && (!start || d >= new Date(start)) && (!end || d <= new Date(end));
            }).length;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${task}</td><td><span class="count-badge">${total}</span></td>`;
            tbody.appendChild(tr);
        });
    }

    function updateBarCharts() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const grid = document.getElementById('chartsGrid');
        grid.innerHTML = '';
        if (!allData || allData.length <= 1) return;

        TASK_LIST.forEach((task, index) => {
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            accordionItem.innerHTML = `
                <button class="accordion-header" onclick="toggleAccordion(this)">ğŸ“Š ${task} æ’è¡Œæ¦œ</button>
                <div class="accordion-content"><div class="chart-container"><canvas id="bar-${index}"></canvas></div></div>
            `;
            grid.appendChild(accordionItem);

            const stats = EMPLOYEE_LIST.map(name => {
                const count = allData.slice(1).filter(row => {
                    const d = new Date(row[2]);
                    return row[0] === name && row[1] === task && (!start || d >= new Date(start)) && (!end || d <= new Date(end));
                }).length;
                return { name, count };
            }).sort((a, b) => b.count - a.count);

            new Chart(document.getElementById(`bar-${index}`), {
                type: 'bar',
                data: { labels: stats.map(s => s.name), datasets: [{ label: 'å®Œæˆæ¬¡æ•¸', data: stats.map(s => s.count), backgroundColor: '#3498db' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        });
    }

    function toggleAccordion(button) {
        button.classList.toggle('active');
        const content = button.nextElementSibling;
        content.style.display = (content.style.display === "block") ? "none" : "block";
    }

    function showPersonalRadar(name, btnElement) {
        if (!name) return;
        const rStart = document.getElementById('radarStartDate').value;
        const rEnd = document.getElementById('radarEndDate').value;

        if (rStart && rEnd) {
            const diffDays = Math.ceil(Math.abs(new Date(rEnd) - new Date(rStart)) / (1000 * 60 * 60 * 24));
            if (diffDays > 90) return alert("å€é–“æœ€é•·ä¸å¾—è¶…é 3 å€‹æœˆã€‚");
        }

        if (btnElement) {
            document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        const stats = TASK_LIST.map(task => {
            return allData.slice(1).filter(row => {
                const d = new Date(row[2]);
                return row[0] === name && row[1] === task && (!rStart || d >= new Date(rStart)) && (!rEnd || d <= new Date(rEnd));
            }).length;
        });

        const ctx = document.getElementById('personalRadarChart').getContext('2d');
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: { labels: TASK_LIST, datasets: [{ label: name, data: stats, backgroundColor: 'rgba(231, 76, 60, 0.2)', borderColor: '#e74c3c', pointBackgroundColor: '#e74c3c' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, ticks: { display: false, stepSize: 1 } } } }
        });

        const dataTable = document.getElementById('radarDataTable');
        let tableHtml = '';
        TASK_LIST.forEach((task, i) => {
            tableHtml += `<tr><td class="label-cell">${task}</td><td class="value-cell">${stats[i]} æ¬¡</td></tr>`;
        });
        dataTable.innerHTML = tableHtml;
    }

    async function submitReport() {
        const name = document.getElementById('userName').value;
        const task = document.getElementById('taskName').value;
        if (!name || !task) return alert("è«‹å®Œæ•´å¡«å¯«äººå“¡èˆ‡ä»»å‹™");
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name, task }) });
            alert("æäº¤æˆåŠŸï¼");
            setTimeout(loadDataAndDraw, 1500);
        } catch (e) { alert("æäº¤å¤±æ•—"); }
    }

    window.onload = function() {
        setupUI();
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const today = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = firstDay;
        document.getElementById('endDate').value = today;
        document.getElementById('radarStartDate').value = firstDay;
        document.getElementById('radarEndDate').value = today;
        document.getElementById('radarStartDate').onchange = () => showPersonalRadar(currentUserName);
        document.getElementById('radarEndDate').onchange = () => showPersonalRadar(currentUserName);
        loadDataAndDraw();
    };
</script>
</body>
</html>
